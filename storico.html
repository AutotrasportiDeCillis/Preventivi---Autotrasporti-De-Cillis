<!DOCTYPE html>
<html>
<head>
    <title>Storico Preventivi - Autotrasporti De Cillis</title>
    <script src="jspdf.umd.min.js"></script> 
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f6; color: #333; line-height: 1.6; }
        .container { max-width: 1300px; margin: 30px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; padding-bottom: 20px;}
        .header img { max-width: 100px; height: auto; margin-bottom: 10px; border-radius: 4px;}
        .header h1 { color: #2c3e50; font-size: 1.8em; margin: 5px 0 10px; }
        .info-dettagli { font-size: 0.9em; color: #777; font-weight: normal; }
        a.back-link { display: inline-block; margin-bottom: 20px; text-decoration: none; color: #3498db; }
        a.back-link:hover { text-decoration: underline; }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 30px;}
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #3498db; color: white; font-size: 0.9em; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .btn-delete { background: none; border: none; cursor: pointer; color: #e74c3c; font-size: 1.2em; padding: 0 0 0 5px; margin-left: 5px; }
        .btn-download { background: none; border: none; cursor: pointer; color: #28a745; font-size: 1.2em; padding: 0; margin-right: 5px;}
        .btn-download-detail { background: none; border: none; cursor: pointer; color: #f39c12; font-size: 1.2em; padding: 0; margin-right: 5px;}
        .btn-delete:hover { color: #c0392b; }
        .btn-download:hover { color: #1e7e34; }
        .btn-download-detail:hover { color: #e67e22; }
        #bulkDeleteButton { background-color: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; float: right;}
        #bulkDeleteButton:hover { background-color: #c0392b; }
        .table-footer { overflow: hidden; margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee;}
        #messaggioVuoto { margin-top: 30px; font-size: 1.2em; color: #777; text-align: center;}
    </style>
</head>
<body onload="caricaStorico()">

    <div class="container">
        <a href="preventivatore.html" class="back-link">‚Üê Torna al Preventivatore</a>

        <div class="header">
            <img src="2.png" alt="Logo Autotrasporti De Cillis" id="appLogo" style="display: none;">
            <h1>Storico Preventivi Autotrasporti De Cillis</h1>
            <div class="info-dettagli">
                <strong>P.IVA:</strong> 02574400020 | 
                <strong>Email:</strong> autotrasportidecillis@gmail.com
            </div>
        </div>
        
        <h2>Preventivi Registrati</h2>

        <div id="storico-container">
            <p id="messaggioVuoto" style="display:none;">Nessun preventivo salvato.</p>
        </div>
        
        <div class="table-footer">
            <button id="bulkDeleteButton" onclick="cancellaTutto()">Cancella TUTTI i Preventivi Salvati dal CLOUD</button>
        </div>
    </div>

    <script>
        // Inclusione libreria jsPDF AutoTable (NECESSARIA per il PDF Dettaglio)
        document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></' + 'script>');
        
        // === CONFIGURAZIONE FIREBASE INSERITA DALL'UTENTE ===
        const firebaseConfig = {
            apiKey: "AIzaSyAPXp7geS7Srr2rWHHqwrJfbze3PoMdLzk",
            authDomain: "preventivi---de-cillis.firebaseapp.com",
            projectId: "preventivi---de-cillis",
            storageBucket: "preventivi---de-cillis.firebasestorage.app",
            messagingSenderId: "985249210481",
            appId: "1:985249210481:web:82ab65ea03a58a223fbbd0"
        };
        // =======================================================================================
        
        // Inizializza Firebase
        let db;
        try {
             firebase.initializeApp(firebaseConfig);
             db = firebase.database();
             console.log("Firebase Database Connesso.");
        } catch (e) {
             console.error("ERRORE: Impossibile connettersi a Firebase. Controlla la configurazione.", e);
             alert("ERRORE: Impossibile connettersi al database. I dati potrebbero non essere aggiornati.");
        }
        
        const FIREBASE_PATH = 'preventivi_storico'; 

        const CONFIGURAZIONE_TASSI = { "IVA": 0.22 }; // Manteniamo solo l'IVA per i calcoli
        const TITOLO_AZIENDA = "AUTOTRASPORTI DE CILLIS";
        const P_IVA_AZIENDA = "02574400020"; // Aggiornata per coerenza
        const EMAIL_AZIENDA = "autotrasportidecillis@gmail.com";
        
        let logoBase64 = null;


        // --- GESTIONE DEL LOGO (2.png) ---
        function gestisciLogoDisplay() {
            const img = document.getElementById('appLogo');
            const image = new Image();
            image.src = "2.png"; 
            image.crossOrigin = "Anonymous"; 

            image.onload = function() {
                img.style.display = 'inline-block';
                try {
                    const canvas = document.createElement("canvas");
                    canvas.width = image.naturalWidth;
                    canvas.height = image.naturalHeight;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(image, 0, 0);
                    logoBase64 = canvas.toDataURL("image/png");
                } catch (e) {
                    console.error("Errore nel convertire il logo 2.png in Base64 per il PDF.");
                    logoBase64 = null; 
                }
            };
            image.onerror = function() {
                console.error("Logo '2.png' non trovato.");
            };
        }

        // --- Funzione per caricare e visualizzare lo storico (DA Firebase) ---
        function caricaStorico() {
            gestisciLogoDisplay(); 
            
            if (!db) { return; } 

            const container = document.getElementById('storico-container');
            const messaggioVuoto = document.getElementById('messaggioVuoto');
            messaggioVuoto.style.display = 'none';
            container.innerHTML = '<p style="text-align:center; color:#555;">Caricamento storico in corso...</p>';
            document.getElementById('bulkDeleteButton').style.display = 'none';


            // Ascolta i cambiamenti in tempo reale (on) per aggiornare la tabella
            db.ref(FIREBASE_PATH).on('value', (snapshot) => {
                let storico = [];
                if (snapshot.exists()) {
                     const datiRaw = snapshot.val();
                     for (let key in datiRaw) {
                         storico.push(datiRaw[key]);
                     }
                     // Ordina per numero di protocollo progressivo
                     storico.sort((a, b) => {
                        const numA = parseInt(a.protocollo.split('/')[1]);
                        const numB = parseInt(b.protocollo.split('/')[1]);
                        return numA - numB;
                     });
                }

                if (storico.length === 0) {
                    messaggioVuoto.style.display = 'block';
                    container.innerHTML = '';
                    document.getElementById('bulkDeleteButton').style.display = 'none';
                    return;
                }

                document.getElementById('bulkDeleteButton').style.display = 'inline-block';

                let html = '<table><thead><tr>';
                html += '<th>Protocollo</th><th>Data</th><th>Cliente</th><th>Mezzo</th><th>Tratta Iniziale/Finale</th><th>Km Totali</th><th>Totale Base (‚Ç¨)</th><th>Totale Finale (‚Ç¨)</th><th>Azione</th>';
                html += '</tr></thead><tbody>';

                storico.forEach(p => {
                    // Controlla il campo per compatibilit√† con vecchi record
                    const mezzo = p.tipoMezzoGlobale || 'N/D (Vecchio Formato)'; 
                    const trattaDisplay = (p.trattaDa && p.trattaA)
                        ? `${p.trattaDa} ‚Üí ${p.trattaA} ${p.dettaglioTappe ? '(' + p.dettaglioTappe.length + ' Tappe)' : ''}`
                        : 'N/D';
                    
                    html += `<tr>`;
                    html += `<td>${p.protocollo}</td>`;
                    html += `<td>${p.data}</td>`;
                    html += `<td>${p.cliente}</td>`;
                    html += `<td>${mezzo}</td>`; 
                    html += `<td>${trattaDisplay}</td>`;
                    html += `<td>${p.kmTotali || 'N/D'}</td>`;
                    html += `<td>${p.costoBase || 'N/D'}</td>`; 
                    html += `<td><strong>${p.totaleFinale || 'N/D'}</strong></td>`;
                    html += `<td>
                                <button class="btn-download" title="Scarica PDF Cliente" onclick="scaricaPreventivo('${p.id}', 'client')">‚¨áÔ∏è</button>
                                ${p.dettaglioTappe ? `<button class="btn-download-detail" title="Scarica PDF Dettaglio Interno" onclick="scaricaPreventivo('${p.id}', 'dettaglio')">üìù</button>` : `<button class="btn-download-detail" title="Dettaglio non disponibile (Formato Vecchio)" disabled>‚ùå</button>`}
                                <button class="btn-delete" onclick="cancellaSingolo('${p.id}')">üóëÔ∏è</button>
                             </td>`;
                    html += `</tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            });
        }

        // --- FUNZIONE PER SCARICARE SINGOLO PREVENTIVO (DA Firebase) ---
        function scaricaPreventivo(idDaScaricare, tipoPdf) {
            if (!db) { alert("Connessione Firebase non attiva."); return; }
            
            db.ref(FIREBASE_PATH + '/' + idDaScaricare).once('value', (snapshot) => {
                 const preventivo = snapshot.val();

                 if (preventivo) {
                    if (tipoPdf === 'client') {
                        generaPDF(preventivo);
                    } else {
                        if (!preventivo.dettaglioTappe) {
                            alert("I dati di dettaglio per questo preventivo sono assenti o in formato vecchio. Impossibile generare il PDF Dettaglio.");
                            return;
                        }
                        generaPDFDettaglio(preventivo);
                    }
                 } else {
                    alert("Preventivo non trovato nello storico Cloud. Ricarica la pagina.");
                 }
            });
        }

        // --- FUNZIONE GENERAZIONE PDF CLIENTE (AGGIORNATA) ---
        function generaPDF(record) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const docWidth = doc.internal.pageSize.getWidth();
            const MARGINE_X = 20;
            const LARGHEZZA_MAX_TESTO = docWidth - (MARGINE_X * 2);
            
            // Dati dal record salvato
            const cliente = record.cliente;
            const protocollo = record.protocollo;
            const pIvaCliente = record.pIvaCliente; 
            const tipoMezzo = record.tipoMezzoGlobale || 'Non Specificato'; // Usa il campo Mezzo Globale
            const costoBaseRecord = parseFloat(record.costoBase); 
            const totaleFinale = parseFloat(record.totaleFinale);
            const dataValidita = record.dataValidita; 

            // Ricalcola costo base e IVA
            const costoBase = totaleFinale / (1 + CONFIGURAZIONE_TASSI.IVA);
            const COSTO_IVA = (totaleFinale - costoBase).toFixed(2);
            
            let yPos = 15;
            
            // 1. Intestazione Centrata
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(TITOLO_AZIENDA, docWidth / 2, yPos, { align: 'center' });
            yPos += 7;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`P.IVA: ${P_IVA_AZIENDA}`, docWidth / 2, yPos, { align: 'center' });
            yPos += 5;
            doc.text(`Email: ${EMAIL_AZIENDA}`, docWidth / 2, yPos, { align: 'center' });

            yPos += 8; 
            doc.setDrawColor(200, 200, 200); 
            doc.line(15, yPos, 195, yPos);
            
            // 2. Titolo Principale
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            yPos += 15;
            doc.text("Preventivo", docWidth / 2, yPos, { align: 'center' });
            doc.setFont(undefined, 'normal');
            yPos += 20; 
            
            // 3. Dettagli Cliente e Protocollo
            doc.setFontSize(12);
            
            // Protocollo
            doc.setFont(undefined, 'bold');
            doc.text(`Protocollo N.`, MARGINE_X, yPos);
            yPos += 5;
            doc.setFont(undefined, 'normal');
            doc.text(protocollo, MARGINE_X, yPos); 
            yPos += 10;
            
            // Cliente
            doc.setFont(undefined, 'bold');
            doc.text(`Cliente`, MARGINE_X, yPos);
            yPos += 5;
            doc.setFont(undefined, 'normal');
            const clienteLines = doc.splitTextToSize(cliente, LARGHEZZA_MAX_TESTO);
            doc.text(clienteLines, MARGINE_X, yPos); 
            yPos += (clienteLines.length * 5) + 5; 
            
            // P.IVA/C.F. Cliente (GESTIONE CONDIZIONALE)
            if (pIvaCliente) {
                doc.setFont(undefined, 'bold');
                doc.text(`P.IVA / Codice Fiscale`, MARGINE_X, yPos);
                yPos += 5;
                doc.setFont(undefined, 'normal');
                doc.text(pIvaCliente, MARGINE_X, yPos); 
                yPos += 10;
            }
            
            // Data
            doc.setFont(undefined, 'bold');
            doc.text(`Data Emissione`, MARGINE_X, yPos); 
            yPos += 5;
            doc.setFont(undefined, 'normal');
            doc.text(record.data, MARGINE_X, yPos); 
            yPos += 10;
            
            // Validit√†
            doc.setFont(undefined, 'bold');
            doc.text(`Valido Fino Al`, MARGINE_X, yPos); 
            yPos += 5;
            doc.setFont(undefined, 'normal');
            doc.text(dataValidita, MARGINE_X, yPos); 
            yPos += 10;
            
            // Tipo Mezzo (AGGIUNTO)
            doc.setFont(undefined, 'bold');
            doc.text(`Tipo Mezzo Utilizzato:`, MARGINE_X, yPos);
            yPos += 5;
            doc.setFont(undefined, 'normal');
            doc.text(tipoMezzo, MARGINE_X, yPos); 
            yPos += 15;
            
            // 4. SEZIONE COSTI (SOLO TOTALI)
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("RIEPILOGO COSTI", MARGINE_X, yPos); 
            doc.setFont(undefined, 'normal'); yPos += 10;
            doc.setFontSize(12);
            
            const FINE_MARGINE_X = docWidth - MARGINE_X;
            
            // PRIMO TOTALE (IVA ESCLUSA)
            doc.setFont(undefined, 'bold');
            doc.text(`Totale Base (IVA Escl.):`, MARGINE_X, yPos);
            doc.text(`${costoBaseRecord} ‚Ç¨`, FINE_MARGINE_X, yPos, { align: 'right' }); yPos += 7;
            
            // IVA
            doc.setFont(undefined, 'normal');
            doc.text(`Aliquota IVA (${(CONFIGURAZIONE_TASSI.IVA * 100).toFixed(0)}%):`, MARGINE_X, yPos);
            doc.text(`${COSTO_IVA} ‚Ç¨`, FINE_MARGINE_X, yPos, { align: 'right' }); yPos += 7;
            
            doc.line(MARGINE_X, yPos, FINE_MARGINE_X, yPos); 
            yPos += 7;
            
            // TOTALE FINALE (IVA INCLUSA)
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text("TOTALE FINALE (IVA INCLUSA):", MARGINE_X, yPos);
            doc.text(`${totaleFinale.toFixed(2)} ‚Ç¨`, FINE_MARGINE_X, yPos, { align: 'right' }); 
            doc.setFont(undefined, 'normal'); yPos += 10;
            doc.line(MARGINE_X, yPos, FINE_MARGINE_X, yPos);
            
            const nomeFile = `Preventivo_N${protocollo.replace('/', '-')}_${cliente.replace(/ /g, '_')}.pdf`;
            doc.save(nomeFile);
        }

        // --- FUNZIONE GENERAZIONE PDF DETTAGLIO INTERNO (AGGIORNATA) ---
        function generaPDFDettaglio(record) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const docWidth = doc.internal.pageSize.getWidth();
            const MARGINE_X = 10;
            
            const dettaglio = record.dettaglioTappe;
            const CLEAN_REGEX = /[\u2018\u2019\u201c\u201d\u2032\u2033!‚Äô]/g; 
            
            let yPos = 15;
            
            // Intestazione
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(TITOLO_AZIENDA, docWidth / 2, yPos, { align: 'center' });
            yPos += 7;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Preventivo N. ${record.protocollo}`, docWidth / 2, yPos, { align: 'center' });
            yPos += 5;
            doc.text(`Cliente: ${record.cliente} | Mezzo: ${record.tipoMezzoGlobale}`, docWidth / 2, yPos, { align: 'center' });
            
            yPos += 15; 
            
            // 1. Dettagli riepilogativi (nuova impostazione)
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("RIEPILOGO VIAGGIO", MARGINE_X, yPos);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal'); yPos += 8;
            
            doc.text(`Tratta Totale: ${record.trattaDa.replace(CLEAN_REGEX, '')} ‚Üí ${record.trattaA.replace(CLEAN_REGEX, '')}`, MARGINE_X, yPos); yPos += 5;
            doc.text(`Totale Km per tutte le tappe: ${record.kmTotali} km`, MARGINE_X, yPos); yPos += 5;
            doc.text(`Data Emissione: ${record.data}`, MARGINE_X, yPos); yPos += 10;
            
            // Separatore
            doc.setDrawColor(200, 200, 200); 
            doc.line(MARGINE_X, yPos, docWidth - MARGINE_X, yPos);
            yPos += 5;

            // 2. Dettaglio Tappe
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("DETTAGLIO SPEDIZIONE PER TAPPA", MARGINE_X, yPos); 
            doc.setFont(undefined, 'normal'); 
            yPos += 10; // Spazio pulito dopo il titolo
            

            // Tabella Dettaglio Tappe
            const tableData = dettaglio.map(t => [
                `Tappa ${t.tappa}`,
                // Applicazione della pulizia
                `${t.trattaDa.replace(CLEAN_REGEX, '')} ‚Üí ${t.trattaA.replace(CLEAN_REGEX, '')}`,
                t.statoMezzo,
                `${t.kmTappa} km`,
                `${t.prezzoKmUsato} ‚Ç¨/km`,
                `${t.costoTappa} ‚Ç¨`
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['Tappa', 'Tratta (Partenza ‚Üí Arrivo)', 'Stato Mezzo', 'Km', 'Prezzo/Km Applicato', 'Costo Tappa']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [31, 69, 106], fontStyle: 'bold' },
                 // Configurazione larghezza colonne per evitare il taglio del testo e garantire la leggibilit√†
                columnStyles: {
                    0: { cellWidth: 20 },   // Tappa
                    1: { cellWidth: 65 },   // Tratta 
                    2: { cellWidth: 30 },   // Stato
                    3: { cellWidth: 20 },   // Km
                    4: { cellWidth: 30 },   // Prezzo/Km Applicato
                    5: { cellWidth: 25 }    // Costo Tappa
                },
                margin: { left: MARGINE_X, right: MARGINE_X },
                didDrawPage: function (data) {
                    yPos = data.cursor.y;
                }
            });
            
            yPos = doc.autoTable.previous.finalY + 10;
            
            // 3. Riepilogo finale
            const FINE_MARGINE_X = docWidth - MARGINE_X;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("RIEPILOGO ECONOMICO", MARGINE_X, yPos); 
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal'); yPos += 10;
            
            doc.setFont(undefined, 'bold');
            doc.text(`Totale Base (Somma costi tappe - IVA Escl.):`, MARGINE_X, yPos);
            doc.text(`${record.costoBase} ‚Ç¨`, FINE_MARGINE_X, yPos, { align: 'right' }); yPos += 7;
            
            const costoBase = parseFloat(record.totaleFinale) / (1 + CONFIGURAZIONE_TASSI.IVA);
            const COSTO_IVA = (parseFloat(record.totaleFinale) - costoBase).toFixed(2);
            
            doc.setFont(undefined, 'normal');
            doc.text(`Aliquota IVA (${(CONFIGURAZIONE_TASSI.IVA * 100).toFixed(0)}%):`, MARGINE_X, yPos);
            doc.text(`${COSTO_IVA} ‚Ç¨`, FINE_MARGINE_X, yPos, { align: 'right' }); yPos += 7;
            
            doc.line(MARGINE_X, yPos, FINE_MARGINE_X, yPos); 
            yPos += 7;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text("TOTALE FINALE (IVA INCLUSA):", MARGINE_X, yPos);
            doc.text(`${record.totaleFinale} ‚Ç¨`, FINE_MARGINE_X, yPos, { align: 'right' }); 
            
            const nomeFile = `Preventivo_N${record.protocollo.replace('/', '-')}_${record.cliente.replace(/ /g, '_')}_DETTAGLIO_INT_REPRINT.pdf`;
            doc.save(nomeFile);
        }
        
        // --- Funzioni di gestione storico (CANCELLAZIONE da Firebase) ---
        function cancellaSingolo(idDaCancellare) {
            if (!db) { alert("Connessione Firebase non attiva."); return; }
            if (!confirm("Sei sicuro di voler cancellare questo preventivo dal CLOUD?")) {
                return;
            }

            db.ref(FIREBASE_PATH + '/' + idDaCancellare).remove()
                .then(() => {
                    alert("Preventivo cancellato dal Cloud.");
                })
                .catch((error) => {
                    alert("Errore durante la cancellazione. Controlla la console.");
                    console.error("Errore cancellazione:", error);
                });
        }
        
        function cancellaTutto() {
            if (!db) { alert("Connessione Firebase non attiva."); return; }
            const conferma1 = confirm("SEI SICURO di voler cancellare TUTTI i preventivi salvati dal CLOUD?");
            if (!conferma1) return;

            const conferma2 = confirm("ULTIMA CONFERMA: Cliccando OK, tutti i preventivi andranno persi su TUTTI i dispositivi.");
            if (!conferma2) return;

            db.ref(FIREBASE_PATH).set(null)
                .then(() => {
                    alert("Tutti i preventivi sono stati cancellati dal Cloud.");
                })
                .catch((error) => {
                    alert("Errore durante la cancellazione totale. Controlla la console.");
                    console.error("Errore cancellazione totale:", error);
                });
        }

        document.addEventListener('DOMContentLoaded', gestisciLogoDisplay);
        document.addEventListener('DOMContentLoaded', caricaStorico);

    </script>

</body>
</html>